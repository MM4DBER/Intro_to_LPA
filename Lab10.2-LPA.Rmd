---
title: "Lab 10.2 - Latent Profile Analysis "
author: "*Adam Garber*"
subtitle: 'Structural Equation Modeling - Instructor: Karen Nylund-Gibson'
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  prettydoc::html_pretty:
    theme: architect
    highlight: github
    toc: yes
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE)
library(prettydoc)
library(here)
```

`University of California, Santa Barbara`

```{r, echo=FALSE, eval=TRUE, out.width = "60%", out.height= "60%", fig.pos="h"}

knitr::include_graphics(here("figures", "lpa_mix_density.png"))
```

*Figure*. Gaussian mixture models. Data simulated from a 2-class model. 

______________________________________________

# Lab preparation

______________________________________________

## Creating a version-controlled R-Project with Github

Download repository here: https://github.com/garberadamc/SEM-Lab10

On the Github repository webpage:

a. `fork` your own `branch` of the lab repository 
b. copy the repository web URL address from the `clone or download` menu

Within R-Studio:

c. click "NEW PROJECT" 
d. choose option `Version Control`
e. choose option `Git`
f. paste the repository web URL path copied from the `clone or download` menu on Github page
g. choose location of the R-Project 

______________________________________________

## Data source:

1. The first example closely follows the vignette used to demonstrate the `tidyLPA` package (Rosenberg, 2019): [$\color{blue}{\text{See detailed documentation of this model here}}$](https://data-edu.github.io/tidyLPA/articles/Introduction_to_tidyLPA.html)

  This model utilizes the `PISA` data collected in the U.S. in 2015. To learn more about this data [$\color{blue}{\text{see here}}$](http://www.oecd.org/pisa/data/). 

  To access the 2015 US `PISA` data in R use the following code:
  a. `devtools::install_github("jrosen48/pisaUSA15")`
  b. `library(pisaUSA15)`
  c. `open_codebook()`

2. The second examples utilizes 4 test score measures from the public-use dataset, *The Longitudinal Survey of American Youth* (**LSAY**):  [$\color{blue}{\text{See documentation here}}$](https://www.lsay.org/)

______________________________________________

Load packages
```{r, eval=TRUE}

library(naniar)
library(tidyverse)
library(haven)
library(glue)
library(MplusAutomation)
library(rhdf5)
library(here)
library(janitor)
library(gt)
library(tidyLPA)

```

Load data
```{r, eval=TRUE}
pisa <- pisaUSA15
```

___________________________________

# Latent Profile Analysis 

___________________________________

```{r, echo=FALSE, eval=TRUE, out.width = "60%", out.height= "60%", fig.pos="h"}

knitr::include_graphics(here("figures", "var_covar_matrix.png"))

```

*Figure*. Picture adapted from tutorial (Rosenberg, 2019).

- `model 1`: Equal variances, and covariances fixed to 0 (Class-invariant / Diagonal)
- `model 2`: Free variances and covariances fixed to 0 (Class-varying / Diagonal)
- `model 3`: Equal variances and equal covariances (Class-invariant / Non-Diagonal)
- `model 4`: Free variances, and equal covariances
- `model 5`: Equal variances, and free covariances 
- `model 6`: Free variances and free covariances (Class Varying / Non-Diagonal)

___________________________________

## Example 1: PISA dataset from the `tidyLPA` package

___________________________________

Enumerate using `estimate_profiles()`:

- Estimate models with classes $K = 1:3$ using Mplus
- Model has 4 continuous indicators
- Default variance-covariance sprecifications is model 1
- In the followind example model 1 and model 6 are compared
- Add line `scale() %>%` to center indicator means


```{r}
lpa_models <- pisa[1:500,] %>%
    select(broad_interest, enjoyment, instrumental_mot, self_efficacy) %>%
    estimate_profiles(1:3,
                      package = "MplusAutomation",
                      ANALYSIS = "starts = 100, 20;",
                      variances = c("equal", "varying"),
                      covariances = c("zero", "varying"))

get_fit(lpa_models)
```

___________________________________

Plot 3-class model

**Note:** single imputation is used in this example as `plot_profiles()` requires complete cases
```{r, eval=TRUE}
pisa[1:200,] %>%
    select(broad_interest, enjoyment, instrumental_mot, self_efficacy) %>%
    single_imputation() %>%
    estimate_profiles(3, package = "MplusAutomation") %>% 
    plot_profiles(sd=FALSE)
```

___________________________________

Plot densities for classes `k = 1:4`
```{r, eval=TRUE}

pisa[1:500, c("broad_interest","enjoyment")] %>%
  single_imputation() %>%
  estimate_profiles(1:4, package = "MplusAutomation") %>%
  plot_density()

```

___________________________________

## Example 2: Math, Science, Physics, and Biology measures (LSAY).

___________________________________


Read in data 
```{r, eval=TRUE}

lsay_data <- read_csv(here("data", "lsay_lab10.2_lpa.csv"))

```

___________________________________

A. Run a quick enumeration (default variance-covariance specification - `model 1`)
```{r}

lpa_k14  <- lapply(1:4, function(k) {
  lpa_enum  <- mplusObject(
      
    TITLE = glue("Class {k}A"), 
  
    VARIABLE = glue(
    "usevar = mth_scor-bio_scor;
     classes = c({k}); "),
  
  ANALYSIS = 
   "estimator = mlr; 
    type = mixture;
    starts = 200 50; 
    processors = 10;",
  
  OUTPUT = "sampstat residual tech11 tech14;",
  
  PLOT = 
    "type = plot3; 
     series = mth_scor-bio_scor(*);",
  
  usevariables = colnames(lsay_data),
  rdata = lsay_data)

lpa_enum_fit <- mplusModeler(lpa_enum, 
    dataout=glue(here("enum_lpa", "c_lpaA_lsay_Lab10.dat")),
    modelout=glue(here("enum_lpa", "c{k}_lpaA_lsay_Lab10.inp")) ,
    check=TRUE, run = TRUE, hashfilename = FALSE)
})

```

___________________________________

Plot $1:4$ class model profiles
```{r, eval=TRUE}
lsay_data[1:500,5:8] %>%
    single_imputation() %>%
    estimate_profiles(1:4, package = "MplusAutomation") %>% 
    plot_profiles(sd=FALSE)
```

*Figure.* Here we see ordered solutions.

This result might be aniticipated given that the correlation between test scores ranges from moderate to high (*r* = .57 - .95).

___________________________________

Compare model fit.
```{r}
all_output <- readModels(here("enum_lpa"), quiet = TRUE)

enum_extract <- LatexSummaryTable(all_output,                                             #
                keepCols=c("Title","Parameters", "LL", "BIC",                             #
                           "aBIC", "BLRT_PValue", "T11_VLMR_PValue"),                     #
                sortBy = "Title")                                                         #

gt(enum_extract)
```

___________________________________

## Which variance-covariance specification is appropriate?

In this tutorial we consider the following three models:
A. equal variances and covariances fixed to zero (default)
B. free variances and covariances fixed to zero (Model 2)
C. free variances and free covariance for Physics and Science test scores (Model 6)

___________________________________

```{r, echo=FALSE, eval=TRUE, out.width = "60%", out.height= "60%", fig.pos="h"}

knitr::include_graphics(here("figures", "lpa_1.png"))
```

*Figure*. Picture adapted from lecture slides by Karen Nylund-Gibson. 

___________________________________

Concept check 1: Equal Variances & Covariances fixed to zero

```{r, echo=FALSE, eval=TRUE, out.width = "60%", out.height= "60%", fig.pos="h"}

knitr::include_graphics(here("figures", "lpa_2.png"))
```

*Figure*. Picture of "diagonal class-invariant model" adapted from lecture slides by Karen Nylund-Gibson. 

___________________________________

Concept check 2: Unequal Variances & Free Covariances

```{r, echo=FALSE, eval=TRUE, out.width = "60%", out.height= "60%", fig.pos="h"}

knitr::include_graphics(here("figures", "lpa_3.png"))
```

*Figure*. Picture of "non-diagonal class-varying model" adapted from lecture slides by Karen Nylund-Gibson. 

___________________________________

B. Run enumeration specifying free variances 
```{r}

lpa_k14B  <- lapply(1:4, function(k) {
  lpa_enumB  <- mplusObject(
      
    TITLE = glue("Class {k}B"), 
  
    VARIABLE = glue(
    "usevar = mth_scor-bio_scor;
     classes = c({k}); "),
  
  ANALYSIS = 
   "estimator = mlr; 
    type = mixture;
    starts = 200 50; 
    processors = 10;",
  
  MODEL = 
    "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
     ! THE # OF CLASS-SPECIFIC STATEMENTS MUST BE EDITED TO CORRESPOND WITH K!
     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    
     %c#1%
     [mth_scor-bio_scor];    ! means are are freely estimated 
     mth_scor-bio_scor;      ! variances are freely estimated

     %c#2%
     [mth_scor-bio_scor];
     mth_scor-bio_scor;

     %c#3%
     [mth_scor-bio_scor];
     mth_scor-bio_scor;
     
     %c#4%
     [mth_scor-bio_scor];
     mth_scor-bio_scor;",
  
  OUTPUT = "sampstat residual tech11 tech14;",
  
  PLOT = 
    "type = plot3; 
     series = mth_scor-bio_scor(*);",
  
  usevariables = colnames(lsay_data),
  rdata = lsay_data)

lpa_enumB_fit <- mplusModeler(lpa_enumB, 
    dataout=glue(here("enum_lpa", "c_lpaB_lsay_Lab10.dat")),
    modelout=glue(here("enum_lpa", "c{k}_lpaB_lsay_Lab10.inp")) ,
    check=TRUE, run = TRUE, hashfilename = FALSE)
})

```

***

C. Run enumeration specifying free variances and free covariances
```{r}

lpa_k14C  <- lapply(1:4, function(k) {
  lpa_enumC  <- mplusObject(
      
    TITLE = glue("Class {k}C"), 
  
    VARIABLE = glue(
    "usevar = mth_scor-bio_scor;
     classes = c({k}); "),
  
  ANALYSIS = 
   "estimator = mlr; 
    type = mixture;
    starts = 200 50; 
    processors = 10;",
  
  MODEL = 
    "!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
     ! THE # OF CLASS-SPECIFIC STATEMENTS MUST BE EDITED TO CORRESPOND WITH K!
     !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
     %c#1%
     [mth_scor-bio_scor];    ! means are are freely estimated 
     mth_scor-bio_scor;      ! variances are freely estimated
     sci_scor with phy_scor;

     %c#2%
     [mth_scor-bio_scor];
     mth_scor-bio_scor;
     sci_scor with phy_scor;

     %c#3%
     [mth_scor-bio_scor];
     mth_scor-bio_scor;
     sci_scor with phy_scor;
     
     %c#4%
     [mth_scor-bio_scor];
     mth_scor-bio_scor;",
  
  OUTPUT = "sampstat residual tech11 tech14;",
  
  PLOT = 
    "type = plot3; 
     series = mth_scor-bio_scor(*);",
  
  usevariables = colnames(lsay_data),
  rdata = lsay_data)

lpa_enumC_fit <- mplusModeler(lpa_enumC, 
    dataout=glue(here("enum_lpa", "c_lpaC_lsay_Lab10.dat")),
    modelout=glue(here("enum_lpa", "c{k}_lpaC_lsay_Lab10.inp")) ,
    check=TRUE, run = TRUE, hashfilename = FALSE)
})

```

***

## Compare model fit
```{r, eval=TRUE}
all_output <- readModels(here("enum_lpa"), quiet = TRUE)

enum_extract <- LatexSummaryTable(all_output,                                             #
                keepCols=c("Title","Parameters", "LL", "BIC",                             #
                           "aBIC", "BLRT_PValue", "T11_VLMR_PValue"),                     #
                sortBy = "Title")                                                         #

gt(enum_extract)
```


______________________________________________

# [Lab Materials - Return to Home Page](https://garberadamc.github.io/project-site/)

______________________________________________

# References

Hallquist, M. N., & Wiley, J. F. (2018). MplusAutomation: An R Package for Facilitating Large-Scale Latent Variable Analyses in Mplus. Structural equation modeling: a multidisciplinary journal, 25(4), 621-638.

Miller, J. D., Hoffer, T., Suchner, R., Brown, K., & Nelson, C. (1992). LSAY codebook. Northern Illinois University.

Muthén, B. O., Muthén, L. K., & Asparouhov, T. (2017). Regression and mediation analysis using Mplus. Los Angeles, CA: Muthén & Muthén.

Muthén, L.K. and Muthén, B.O. (1998-2017).  Mplus User’s Guide.  Eighth Edition. Los Angeles, CA: Muthén & Muthén

Rosenberg, J. M., van Lissa, C. J., Beymer, P. N., Anderson, D. J., Schell, M. J. & Schmidt, J. A. (2019). tidyLPA: Easily carry out Latent Profile Analysis (LPA) using open-source or commercial software [R package]. https://data-edu.github.io/tidyLPA/

R Core Team (2017). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL http://www.R-project.org/

Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686

---------------------------------------------------

![](figures/UCSB_Navy_mark.png){ width=75% }





